# ðŸ§  Regime-Switching GAT Portfolio Manager

> **AI-Powered Asset Allocation using Graph Attention Networks & Hidden Markov Models**

## ðŸš€ Overview

This project implements a sophisticated **Regime-Switching Portfolio Optimization** strategy. It combines **Macro-Economic Regime Detection** (using Hidden Markov Models) with **Graph Neural Networks (GAT)** to dynamically adjust portfolio weights based on market conditions.

---

## ðŸ“‚ Project Structure

The project workflow is divided into the following key notebooks:

| Notebook | Description |
| :--- | :--- |
| **`02_graph_construction.ipynb`** | Downloads market data (SPY) and portfolio assets. Fits a **Gaussian HMM** to detect market regimes. Constructs a correlation-based graph structure where edges typically represent correlations $>0.5$. |
| **`03_model_training.ipynb`** | Defines and trains the **GAT agent**. Separate models are trained for "Bull" (Regime 0) and "Bear/Crash" (Regime 2) states. The loss function enables direct maximization of the Sharpe Ratio. |
| **`04_backtesting.ipynb`** | **(New)** Full backtesting engine. Simulates the changing of regimes over time, switches the active GAT agent, computes daily strategy returns, and generates performance metrics (Equity Curve, Drawdown Analysis). |

---

## ðŸ§® Mathematical Framework

The strategy leverages a hierarchical model combining probabilistic regime detection with geometric deep learning.

### 1. Market Regime Detection (Gaussian HMM)
We model the market state $S_t$ as a discrete latent variable in a Hidden Markov Model, observed through market returns $O_t$.
*   **Transition Probability**: $P(S_t = j | S_{t-1} = i) = A_{ij}$
*   **Emission Probability**: $P(O_t | S_t = k) \sim \mathcal{N}(\mu_k, \Sigma_k)$

The model classifies each day into a regime (e.g., Low Volatility Bull vs. High Volatility Bear) based on the posterior probability $\gamma_t(k) = P(S_t = k | O_{1:T})$.

### 2. Dynamic Graph Construction
The financial market graph $G = (V, E)$ is constructed dynamically:
*   **Nodes ($V$)**: Portfolio assets (Stocks, Gold, etc.).
*   **Edges ($E$)**: Established based on Pearson correlation $\rho_{ij}$ of log-returns.
$$ A_{ij} = \mathbb{I}(|\rho_{ij}| > \tau) $$
where $\tau$ is a regime-specific threshold (e.g., $0.5$).

### 3. Graph Attention Network (GATv2)
The portfolio weights are generated by a GAT that learns to weigh neighbor information strength. The attention coefficient $e_{ij}$ between node $i$ and $j$ is:
$$ e_{ij} = \text{LeakyReLU}(\vec{a}^T [W\vec{h}_i || W\vec{h}_j]) $$
$$ \alpha_{ij} = \text{softmax}_j(e_{ij}) = \frac{\exp(e_{ij})}{\sum_{k \in \mathcal{N}_i} \exp(e_{ik})} $$
$$ \vec{h}_i' = \sigma\left(\sum_{j \in \mathcal{N}_i} \alpha_{ij} W \vec{h}_j\right) $$
The final output is passed through a global softmax to ensure weights sum to 1: $\sum w_i = 1$.

### 4. Objective Function (Sharpe Loss)
We train the agent using a custom loss function that directly attempts to maximize the Sharpe Ratio of the portfolio returns $R_p$:
$$ \mathcal{L} = - \text{Sharpe} = - \frac{E[R_p]}{\sqrt{\text{Var}(R_p) + \epsilon}} $$

---

## ðŸ“Š Strategy Performance (Backtest)

![Performance](assets/Figure_5.png)

### ðŸ’¡ Inference
The equity curve demonstrates the GAT-based strategy (Blue) significantly decoupling from the Benchmark (Gray).
- **Crisis Alpha**: By switching to the "Bear Agent" during detected high-volatility regimes, the strategy preserves capital.
- **Compounding**: The protection during downturns allows for a higher geometric compounding rate.

| Metric | GAT Regime Strategy | Benchmark (Equal Weight) |
| :--- | :--- | :--- |
| **Total Return** | **1819.19%** | 464.12% |
| **Sharpe Ratio** | **2.26** | 1.03 |
| **Max Drawdown** | **-22.07%** | -31.78% |

---

## ðŸ“‰ Market Regime & Graph Analysis

![Regime Analysis](assets/Figure_1.png)
*Figure 1: HMM detects high-volatility "Crash" regimes (Red) vs. stable "Bull" regimes (Green).*

![Graph Structure](assets/Figure_2.png)
*Figure 2: Asset correlation graph topology changes per regime, allowing the GAT to learn different message-passing dynamics for stress periods.*

---
<!-- *Maintained by Antigravity* -->